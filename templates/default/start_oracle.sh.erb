#!/bin/bash

# sets env variables for this script
export ORACLE_HOME=<%= node['oraclexe']['oracle-home'] %>
export ORACLE_SID=<%= node['oraclexe']['oracle-sid'] %>
export PATH=$ORACLE_HOME/bin:$PATH

# Copied from https://github.com/madhead/docker-oracle-xe/blob/master/config/start.sh
# Update HOST with actual value, uniquely generated by Docker on each start
sed -i -E "s/HOST = [^)]+/HOST = $HOSTNAME/g" $ORACLE_HOME/network/admin/listener.ora
sed -i -E "s/HOST = [^)]+/HOST = $HOSTNAME/g" $ORACLE_HOME/network/admin/tnsnames.ora

while true; do
    pmon=`ps -ef | grep pmon_$ORACLE_SID | grep -v grep`

    if [ "$pmon" == "" ]
    then
        date
        /etc/init.d/oracle-xe start
    fi
    sleep 1m
done;
